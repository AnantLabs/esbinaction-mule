<?xml version="1.0"?>
<!--
  Generic tasks and settings for Mule. 
-->
<project name="Mule - generic" basedir="../.."
  xmlns:c="urn:contrib-ant">

  <!-- to avoid unbound variables messages in eclipse -->
  <property name="${env.OS_ESB}" value="" />

  <!-- General locations -->
  <property name="OS_ESB" value="${env.OS_ESB}" />
  <property name="TOOLS" value="${env.OS_ESB}/tools" />
  <property name="LIB" value="${OS_ESB}/libraries" />
  <property name="PATCHES" value="${OS_ESB}/esb/patches" />
  <property name="MULE_HOME"
    value="${OS_ESB}/esb/mule-2.1.0-M1-SNAPSHOT" />
  <property name="workspace.home"
    location="${env.OS_ESB}/workspace/workspace-mule" />
  <property name="work" location="${workspace.home}/mule/work" />

  <echo message="${LIB}/ant-contrib/ant-contrib-1.0b3.jar" />

  <!-- define the tasks for the ant-contrib libraries -->
  <taskdef resource="net/sf/antcontrib/antlib.xml"
    uri="urn:contrib-ant">
    <classpath>
      <pathelement location="${LIB}/ant-contrib/ant-contrib-1.0b3.jar" />
    </classpath>
  </taskdef>

  <!-- JiBX binding compiler task definition -->
  <taskdef name="bind" classname="org.jibx.binding.ant.CompileTask"
    classpath="${LIB}/jibx/lib/jibx-bind.jar" />

  <!-- define the classpath to use for mule -->
  <path id="mule.path">
    <!--	<fileset dir="${PATCHES}/mule/libs/">
      <include name="*.jar"/>
      </fileset> -->
    <pathelement path="${MULE_HOME}/conf" />   
    <fileset dir="${MULE_HOME}/lib/boot">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${MULE_HOME}/lib/endorsed">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${MULE_HOME}/lib/user">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${MULE_HOME}/lib/mule">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${MULE_HOME}/lib/opt">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${TOOLS}/apache-activemq-4.1.1">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${LIB}/jibx/lib/">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${LIB}/xfire-1.2.6/modules">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${LIB}/xfire-1.2.6/lib">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${TOOLS}/openejb-3.0-beta-1/lib">
      <include name="openejb*.jar" />
    </fileset>
    <fileset dir="${TOOLS}/openejb-3.0-beta-1/lib">
      <include name="geronimo-ejb*.jar" />
    </fileset>

    <pathelement path="${workspace.home}/mule/classes" />
  </path>

  <!-- 
    make sure the init directory exists, and show the settings for
    this chapter.
  -->
  <target name="gn:init">
    <mkdir dir="${workspace.home}/work" />
    <echo message="Mule home is set to ${MULE_HOME}." />
    <echo message="Opensource ESB is set to ${OS_ESB}." />
    <echo message="Chapter home is set to ${chapter.home}." />
    <echo message="Workspace home is set to ${workspace.home}." />
  </target>

  <target name="gn:run-mule-with-xmlconfig" depends="gn:init">
    <!-- first compile the classes -->
    <c:if>
      <isset property="classes-filter" />
      <c:then>
        <echo message="Compiling classes" />
        <antcall target="gn:compile-classes">
          <param name="classes-filter" value="${classes-filter}" />
        </antcall>
      </c:then>
    </c:if>

    <c:if>
      <isset property="jibx-mapping" />
      <c:then>
        <echo message="Running jibx" />
        <antcall target="gn:jibx-classes">
          <param name="jibx-mapping" value="${jibx-mapping}" />
        </antcall>
      </c:then>
    </c:if>

    <java fork="true" classpathref="mule.path"
      classname="org.mule.MuleServer">
      <arg line="-config file:${file}" />
      <jvmarg value="-Xdebug" />
      <jvmarg
        value="-Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=n" />
    </java>
  </target>

  <target name="gn:run-java-in-classpath" depends="gn:init">
    <java fork="true" classpathref="mule.path" classname="${class}" />
  </target>

  <target name="gn:compile-classes" depends="gn:init">
    <javac classpathref="mule.path" debug="true"
      destdir="${workspace.home}/mule/classes"
      srcdir="${workspace.home}/mule/src">
      <sourcepath>
        <fileset dir="." includes="${classes-filter}" />
        <fileset dir="." includes="esb/util/**/*" />
      </sourcepath>
    </javac>
  </target>

  <target name="gn:jibx-classes" depends="gn:init">
    <!-- Run JiBX binding compiler -->
    <bind verbose="false" load="true" binding="${jibx-mapping}">
      <classpath>
        <pathelement path="classes" />
        <pathelement location="${LIB}/jibx/libs/jibx-run.jar" />
      </classpath>
    </bind>
  </target>
</project>
